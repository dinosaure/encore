<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Encore (encore.Encore)</title><link rel="stylesheet" href="../../odoc.css"/><meta charset="utf-8"/><meta name="generator" content="odoc 1.5.2"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div class="content"><header><nav><a href="../index.html">Up</a> â€“ <a href="../index.html">encore</a> &#x00BB; Encore</nav><h1>Module <code>Encore</code></h1><h2 id="introduction"><a href="#introduction" class="anchor"></a>Encore, combinators to produce encoder and decoder.</h2><p>The goal of <code>encore</code> is to provide combinators to be able to produce an <code>angstrom</code>'s parser or a <code>lavoisier</code>'s encoder.</p><p>Combinators are more limited than what <code>angstrom</code> can provide, but this limitation gives a chance to us to produce a <code>lavoisier</code>'s encoder and be able to deserialize and serialize the value in the same way.</p><p>By this fact, we can ensure the <i>isomorphism</i>:</p><pre><code class="ml">val p : 'v t

val angstrom : 'v Angstrom.t (* = to_angstrom p *)
val lavoisier : 'v Lavoisier.t (* = to_lavoisier p *)

assert (emit_string (parse_string str angstrom) lavoisier = str) ;
assert (parse_string (emit_string v lavoisier) angstrom = v) ;</code></pre><p>To be able to make the serializer and the deserializer, the user must provide some <i>bijective</i> elements. To be able to parse and encode an <code>int64</code>, you must provide the way to get the value from a <code>string</code> and how you can encode your value to a <code>string</code>:</p><pre><code class="ml">let int64 : (int64, string) = Bij.v
    ~fwd:Int64.of_string
    ~bwd:Int64.to_string</code></pre><p>Then, you are able to play with combinators such as:</p><pre><code class="ml">let p =
  let open Syntax in
  int64 &lt;$&gt; while1 is_digit</code></pre><p>For some values such as Git values, we must respect <i>isomorphism</i> to ensure to inject/extract exactly the same representation of them into a store</p><ul><li>and ensure by this way that we will produce exactly the same hash.</li></ul><h2 id="example"><a href="#example" class="anchor"></a>Example.</h2><p>Let's go about the tree Git object. The formal format of it is:</p><pre>entry := permission ' ' name '\x00' hash tree := entry *</pre><p>We must describe bijective elements such as:</p><pre><code class="ml">let permission = Bij.v ~fwd:perm_of_string ~bwd:perm_to_string

let hash =
  Bij.v ~fwd:Digestif.SHA1.of_raw_string ~bwd:Digestif.SHA1.to_raw_string

type entry = { perm : permission; hash : Digestif.SHA1.t; name : string }

let entry =
  Bij.v
    ~fwd:(fun ((perm, name), hash) -&gt; { perm; hash; name })
    ~bwd:(fun { perm; hash; name } -&gt; ((perm, name), hash))</code></pre><p><b>Note</b> that these functions should raise <a href="Bij/index.html#exception-Bijection"><code>Bij.Bijection</code></a> if they fail when they parse the given string.</p><p>Then, the format of the <code>entry</code> can be described like:</p><pre><code class="ml">let entry =
  let open Encore.Syntax in
  let permission = permission &lt;$&gt; while1 is_not_space in
  let hash = hash &lt;$&gt; fixed 20 in
  let name = while1 is_not_null in
  entry
  &lt;$&gt; (permission
      &lt;* (Bij.char ' ' &lt;$&gt; any)
      &lt;*&gt; (name &lt;* (Bij.char '\x00' &lt;$&gt; any))
      &lt;*&gt; hash
      &lt;* commit)</code></pre><p>And the tree Git object can be described like:</p><pre><code class="ml">let tree = rep0 entry </code></pre><p>Finally, with <code>tree</code> and the design of <code>encore</code>, we can ensure:</p><pre><code class="ml">let assert random_tree_value =
  let p = to_angstrom tree in
  let d = to_lavoisier tree in
  assert (Angstrom.parse_string ~consume:All p
            (Lavoisier.emit_string random_tree_value d) = random_tree_value)</code></pre><p>The goal of such design is to describe only one time a <i>format</i> such as our tree Git object and ensure no corruption when we serialize/deserialize values. For our Git purpose, we ensure to keep the same SHA1 (which depends on contents).</p></header><div class="spec module" id="module-Bij"><a href="#module-Bij" class="anchor"></a><code><span class="keyword">module</span> <a href="Bij/index.html">Bij</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div class="spec module" id="module-Lavoisier"><a href="#module-Lavoisier" class="anchor"></a><code><span class="keyword">module</span> <a href="Lavoisier/index.html">Lavoisier</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><div class="spec module" id="module-Either"><a href="#module-Either" class="anchor"></a><code><span class="keyword">module</span> <a href="Either/index.html">Either</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div><dl><dt class="spec type" id="type-t"><a href="#type-t" class="anchor"></a><code><span class="keyword">type</span> <span>'a t</span></code></dt><dd><p>A <code>encore</code> combinator for values of type <code>'a</code>.</p></dd></dl><dl><dt class="spec value" id="val-to_angstrom"><a href="#val-to_angstrom" class="anchor"></a><code><span class="keyword">val</span> to_angstrom : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> Angstrom.t</span></code></dt><dd><p><code>to_angstrom t</code> is the parser of <code>t</code>.</p></dd></dl><dl><dt class="spec value" id="val-to_lavoisier"><a href="#val-to_lavoisier" class="anchor"></a><code><span class="keyword">val</span> to_lavoisier : <span><span class="type-var">'a</span> <a href="index.html#type-t">t</a></span> <span>&#45;&gt;</span> <span><span class="type-var">'a</span> <a href="Lavoisier/index.html#type-t">Lavoisier.t</a></span></code></dt><dd><p><code>to_lavoisier t</code> is the encoder/serializer of <code>t</code>.</p></dd></dl><div class="spec module" id="module-Syntax"><a href="#module-Syntax" class="anchor"></a><code><span class="keyword">module</span> <a href="Syntax/index.html">Syntax</a> : <span class="keyword">sig</span> ... <span class="keyword">end</span></code></div></div></body></html>